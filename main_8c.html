<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>avr-mbot-backoff: /home/travis/build/larsks/avr-mbot-backoff/main.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">avr-mbot-backoff
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">/home/travis/build/larsks/avr-mbot-backoff/main.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;avr/interrupt.h&gt;</code><br />
<code>#include &lt;avr/io.h&gt;</code><br />
<code>#include &lt;util/delay.h&gt;</code><br />
<code>#include &quot;<a class="el" href="motor_8h_source.html">motor.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="distance_8h_source.html">distance.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="millis_8h_source.html">millis.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="serial_8h_source.html">serial.h</a>&quot;</code><br />
<code>#include &quot;FastPID.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a87f2217d99ae8f416cb25006a918954c"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a87f2217d99ae8f416cb25006a918954c">abs</a>(expr)</td></tr>
<tr class="memdesc:a87f2217d99ae8f416cb25006a918954c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return the absolute value of a numeric value.  <a href="#a87f2217d99ae8f416cb25006a918954c">More...</a><br /></td></tr>
<tr class="separator:a87f2217d99ae8f416cb25006a918954c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7a2bf272c097e11bb0688e7d447097aa"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a7a2bf272c097e11bb0688e7d447097aa"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a7a2bf272c097e11bb0688e7d447097aa">LEDPINREG</a>&#160;&#160;&#160;PINB</td></tr>
<tr class="memdesc:a7a2bf272c097e11bb0688e7d447097aa"><td class="mdescLeft">&#160;</td><td class="mdescRight">LED input register (used for toggling) <br /></td></tr>
<tr class="separator:a7a2bf272c097e11bb0688e7d447097aa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1297b9f865ea572148da00fc043fbe09"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a1297b9f865ea572148da00fc043fbe09"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a1297b9f865ea572148da00fc043fbe09">LEDPORTREG</a>&#160;&#160;&#160;PORTB</td></tr>
<tr class="memdesc:a1297b9f865ea572148da00fc043fbe09"><td class="mdescLeft">&#160;</td><td class="mdescRight">LED port data register. <br /></td></tr>
<tr class="separator:a1297b9f865ea572148da00fc043fbe09"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2b3671e090b0831bfba7d12cfcf2d481"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a2b3671e090b0831bfba7d12cfcf2d481"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a2b3671e090b0831bfba7d12cfcf2d481">LEDPIN</a>&#160;&#160;&#160;_BV(PORTB5)</td></tr>
<tr class="memdesc:a2b3671e090b0831bfba7d12cfcf2d481"><td class="mdescLeft">&#160;</td><td class="mdescRight">LED pin. <br /></td></tr>
<tr class="separator:a2b3671e090b0831bfba7d12cfcf2d481"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3cfa90d68463e14f5afe931b4d2294b4"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a3cfa90d68463e14f5afe931b4d2294b4"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a3cfa90d68463e14f5afe931b4d2294b4">MOTORDDR</a>&#160;&#160;&#160;(DDRD)</td></tr>
<tr class="memdesc:a3cfa90d68463e14f5afe931b4d2294b4"><td class="mdescLeft">&#160;</td><td class="mdescRight">DDR register for motors. <br /></td></tr>
<tr class="separator:a3cfa90d68463e14f5afe931b4d2294b4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aec65609b0f37306c9234c4b18ec7721d"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aec65609b0f37306c9234c4b18ec7721d"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#aec65609b0f37306c9234c4b18ec7721d">MOTORPORT</a>&#160;&#160;&#160;(PORTD)</td></tr>
<tr class="memdesc:aec65609b0f37306c9234c4b18ec7721d"><td class="mdescLeft">&#160;</td><td class="mdescRight">PORT register for motors. <br /></td></tr>
<tr class="separator:aec65609b0f37306c9234c4b18ec7721d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aed8440626417ae3abad6e0a17f8d148c"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aed8440626417ae3abad6e0a17f8d148c"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#aed8440626417ae3abad6e0a17f8d148c">MLEFTDIR</a>&#160;&#160;&#160;(_BV(PORTD4))</td></tr>
<tr class="memdesc:aed8440626417ae3abad6e0a17f8d148c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Left motor direction pin. <br /></td></tr>
<tr class="separator:aed8440626417ae3abad6e0a17f8d148c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5f09ce384c4f8d1978b8e199d0fbac2c"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a5f09ce384c4f8d1978b8e199d0fbac2c"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a5f09ce384c4f8d1978b8e199d0fbac2c">MLEFTPWM</a>&#160;&#160;&#160;(_BV(PORTD5))</td></tr>
<tr class="memdesc:a5f09ce384c4f8d1978b8e199d0fbac2c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Left motor speed control. <br /></td></tr>
<tr class="separator:a5f09ce384c4f8d1978b8e199d0fbac2c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a758a48be7d4264da72ee5a5052e8814b"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a758a48be7d4264da72ee5a5052e8814b"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a758a48be7d4264da72ee5a5052e8814b">MRIGHTDIR</a>&#160;&#160;&#160;(_BV(PORTD7))</td></tr>
<tr class="memdesc:a758a48be7d4264da72ee5a5052e8814b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Right motor direction pin. <br /></td></tr>
<tr class="separator:a758a48be7d4264da72ee5a5052e8814b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af1b3526c16c1cc89751506a77c86032a"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="af1b3526c16c1cc89751506a77c86032a"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#af1b3526c16c1cc89751506a77c86032a">MRIGHTPWM</a>&#160;&#160;&#160;(_BV(PORTD6))</td></tr>
<tr class="memdesc:af1b3526c16c1cc89751506a77c86032a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Right motor speed control. <br /></td></tr>
<tr class="separator:af1b3526c16c1cc89751506a77c86032a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acc0f202cb97fff2e138ec128b513a465"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="acc0f202cb97fff2e138ec128b513a465"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#acc0f202cb97fff2e138ec128b513a465">MLEFTOCR</a>&#160;&#160;&#160;(OCR0A)</td></tr>
<tr class="memdesc:acc0f202cb97fff2e138ec128b513a465"><td class="mdescLeft">&#160;</td><td class="mdescRight">Left motor OCR register. <br /></td></tr>
<tr class="separator:acc0f202cb97fff2e138ec128b513a465"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5daf27ff4b791b4a4b4ca2ee2b8e9f52"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a5daf27ff4b791b4a4b4ca2ee2b8e9f52"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a5daf27ff4b791b4a4b4ca2ee2b8e9f52">MRIGHTOCR</a>&#160;&#160;&#160;(OCR0B)</td></tr>
<tr class="memdesc:a5daf27ff4b791b4a4b4ca2ee2b8e9f52"><td class="mdescLeft">&#160;</td><td class="mdescRight">Right motor OCR register. <br /></td></tr>
<tr class="separator:a5daf27ff4b791b4a4b4ca2ee2b8e9f52"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a065df974f333baa9fea76479b1adfd83"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a065df974f333baa9fea76479b1adfd83"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a065df974f333baa9fea76479b1adfd83">BACKOFF_DISTANCE_CM</a>&#160;&#160;&#160;20</td></tr>
<tr class="memdesc:a065df974f333baa9fea76479b1adfd83"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configure the mbot to stay this many cm away from obstacles. <br /></td></tr>
<tr class="separator:a065df974f333baa9fea76479b1adfd83"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a4fc01d736fe50cf5b977f755b675f11d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a> ()</td></tr>
<tr class="separator:a4fc01d736fe50cf5b977f755b675f11d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae66f6b31b5ad750f1fe042a706a4e3d4"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a> ()</td></tr>
<tr class="separator:ae66f6b31b5ad750f1fe042a706a4e3d4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ae73d650a146a14bd09ecc6f783ddc570"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae73d650a146a14bd09ecc6f783ddc570"></a>
<a class="el" href="structMOTOR.html">MOTOR</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#ae73d650a146a14bd09ecc6f783ddc570">m1</a></td></tr>
<tr class="memdesc:ae73d650a146a14bd09ecc6f783ddc570"><td class="mdescLeft">&#160;</td><td class="mdescRight">Controller for motor 1. <br /></td></tr>
<tr class="separator:ae73d650a146a14bd09ecc6f783ddc570"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aec4d70b364d235d3649688202be60649"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aec4d70b364d235d3649688202be60649"></a>
<a class="el" href="structMOTOR.html">MOTOR</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#aec4d70b364d235d3649688202be60649">m2</a></td></tr>
<tr class="memdesc:aec4d70b364d235d3649688202be60649"><td class="mdescLeft">&#160;</td><td class="mdescRight">Controller for motor 2. <br /></td></tr>
<tr class="separator:aec4d70b364d235d3649688202be60649"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af8646dc745b5ae2205b7777cf4872e91"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="af8646dc745b5ae2205b7777cf4872e91"></a>
FastPID&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#af8646dc745b5ae2205b7777cf4872e91">pid</a></td></tr>
<tr class="memdesc:af8646dc745b5ae2205b7777cf4872e91"><td class="mdescLeft">&#160;</td><td class="mdescRight">PID controller (see <a href="https://github.com/larsks/FastPID/">https://github.com/larsks/FastPID/</a>) <br /></td></tr>
<tr class="separator:af8646dc745b5ae2205b7777cf4872e91"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="a87f2217d99ae8f416cb25006a918954c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define abs</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">expr</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">({ __auto_type _a = (expr); \</div><div class="line">     _a &gt;= 0 ? _a : (_a * -1); })</div></div><!-- fragment -->
<p>Return the absolute value of a numeric value. </p>
<p>This uses gcc's <a href="https://gcc.gnu.org/onlinedocs/gcc/Typeof.html"><code>__auto_type</code></a> keyword to avoid evaluating <code>expr</code> multiple times. </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ae66f6b31b5ad750f1fe042a706a4e3d4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The backoff distance is specified in cm, but we need to convert that into microseconds to match the units returned by the <code>measure_value()</code> function. The velocity of sound through air is approximately 340M/s, which comes to about about 29 us/cm. Since the ultrasonic sensor is measuring the round-trip distance of a pulse, we multiple our <code>BACKOFF_DISTANCE_CM</code> value by 58.</p>
<p>Track button state so that we can detect a button press</p>
<p>Pressing the button toggles <code>motors_enabled</code> on and off. When <code>motors_enabled</code> is false, the motor speed is fixed at 0.</p>
<h2>Configuring ADMUX</h2>
<p>The button on an mbot is wired to analog port <code>A7</code>. We can't perform digital reads on this port so we need to utilize the microcontroller's ADC functionality.</p>
<p>We configure <code>ADMUX</code> for <code>AREF</code> connected to 5v, we set <code>ADLAR</code> so that we only need to read <code>ADCH</code> to detect a button press, and we enable ADC on port <code>A7</code>.</p>
<h2>Configuring ADCSRA</h2>
<p>The ADC requires an input clock frequency between 50kHz and 200kHz. Since the mcu is running at 16Mhz, we enable the /128 prescaler by setting <code>ADPS0|ADPS1|ADPS2</code>, which gives gives the ADC a clock frequency of 128kHz.</p>
<p>We set the <code>ADEN</code> bit to enable ADC conversions.</p>
<h2>Main loop</h2>
<p>Read button state by setting <code>ADSC</code> to enable an ADC conversion, then waiting for the ADC result to become available.</p>
<p>Record the current ADC result so that we can watch for high/low state changes.</p>
<p>Toggle the <code>motors_enabled</code> flag if we detect a low-to-high transition (i.e., a button release).</p>
<p>We configured the PID controller with a 50Hz update frequency, which means we need to take a new measurement every 20ms.</p>
<p>We can't use the output from the PID controller directly, so we use it to scale the motor speed (which can be 0-255). The larger the value we get from the PID controller, the faster the motors.</p>
<p>Below a certain speed threshold, the motors just make a whining sound without actually moving. Just set the speed to 0 in this case.</p>
<p>For analysis purposes, during each update of the PID controller we print out the setpoint, the raw measurement from the distance sensor, the output of the PID loop, and the resulting speed.</p>

</div>
</div>
<a class="anchor" id="a4fc01d736fe50cf5b977f755b675f11d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h1>Configure motors</h1>
<p>Configure motor pins as outputs (pwm and direction for each motor).</p>
<p>Enable fast PWM mode on TIMER0 and enable PWM output on <code>OC0A</code> and <code>OC0B</code>.</p>
<p>Configure clk/64 prescaler. The motor PWM frequency is 967Hz. With the mcu running at 16Mhz, the /64 divider gives us a frequency of 967.5625Hz (16000000/64/255) which is "close
enough".</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
